---
title: "ã€å°å“¥å“¥, è·¨åŸŸè¦ä¸è¦äº†è§£ä¸‹ã€‘NGINX åå‘ä»£ç†"
date: "2019-12-04"
permalink: "2019-12-04-nginx-1"
---

### ã€å°å“¥å“¥, è·¨åŸŸè¦ä¸è¦äº†è§£ä¸‹ã€‘NGINX åå‘ä»£ç†

> è½¬è‡ªæ˜é‡‘å¤§ä½¬ [ä¼ é€é—¨](https://juejin.im/post/5c0e6d606fb9a049f66bf246)

> åŸæœ¬æœ¬ç³»åˆ—æ–‡ç« æ˜¯ä¸æ‰“ç®—è¯¦å†™ NGINX åå‘ä»£ç†çš„. è‡³äºä¸ºä»€ä¹ˆä¸æƒ³å†™å‘¢? å½“ç„¶æ˜¯å› ä¸ºæˆ‘ä¸å¤ªä¼šå’¯~~
 
![nginx-1.jpg](http://www.almx.top/image/blog/nginx-1.jpg)

>ä½†æ˜¯, ä¸ä¹…å‰æœ‰å¤§ä½¬ç‚¹äº†è¿™é“èœ, é‚£å½“ç„¶å°±å¾—ä¸Šå•¦ ğŸ˜„

## ä»£ç†æ˜¯ä¸ªå•¥

æ—¢ç„¶è¦èŠåå‘ä»£ç†, é‚£é¦–å…ˆå¾—çŸ¥é“ä»£ç†æ˜¯ä¸ªå•¥å§? å—¯.

![nginx-2.jpg](http://www.almx.top/image/blog/nginx-2.jpg)

### æ­£å‘ä»£ç†

æ¯”å¦‚, ä½ ä¹°æŸèŠ±, æƒ³è¦ç»™éš”å£å·¥ä½çš„æµ‹è¯•å¦¹å­å°ä¸½è¡¨ç™½. ä½†æ˜¯åˆæ€•è¢«äººå®¶ç›´é¢æ‹’ç»å¤ªæ²¡é¢å­. äºæ˜¯ä½ æŠŠé²œèŠ±å§”æ‰˜ç»™å¹³æ—¶å’Œå°ä¸½ä¸€èµ·çš„æµ‹è¯•å°ä¼™ä¼´å°çº¢. è®©å¥¹å¸®å¿™æŠŠèŠ±é€ç»™å°ä¸½. è¿™å°±æ˜¯ä¸€ä¸ªç®€å•çš„ä»£ç†è¿‡ç¨‹, å°çº¢ä½œä¸ºä»£ç†å¸®ä½ æŠŠèŠ±é€ç»™äº†å°ä¸½, å½“ç„¶è¿™ç§æƒ…å†µåœ¨ç°å®ä¸­å¹¶ä¸æ¨èä½¿ç”¨, å› ä¸ºéš¾ä»¥é¿å…ä¸­é—´å•†èµšå·®ä»· ğŸ˜‚.

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­, ä½ ä½œä¸ºå®¢æˆ·ç«¯(è¯·æ±‚æ–¹), æƒ³è¦å‘æœåŠ¡æ–¹(å°ä¸½)å‘èµ·è¯·æ±‚. ä½†æ˜¯ç¢äºé¢å­ä½ ä¸»åŠ¨æ‰¾åˆ°äº†ç¬¬ä¸‰æ–¹(å°çº¢)ä½œä¸ºä»£ç†å‘æœåŠ¡æ–¹å‘é€è¯·æ±‚, è¿™ç§æƒ…å†µå°±æ˜¯å¸¸è¯´çš„æ­£å‘ä»£ç†. æ­£å‘ä»£ç†åœ¨äº’è”ç½‘ä¸­çš„ä½¿ç”¨ä¸»è¦æ˜¯ç§‘å­¦ä¸Šç½‘, ä½ æƒ³è®¿é—®è°·æ­Œä½†æ˜¯ç¢äºé˜²ç«å¢™ä½ åªèƒ½é€šè¿‡vpnæœåŠ¡å™¨ä½œä¸ºä»£ç†æ‰èƒ½è®¿é—®. è¿™ä¸ªæ—¶å€™ä¸€èˆ¬ä¹Ÿè¦æ‰¾å€¼å¾—ä¿¡èµ–çš„vpnå‚å•†, é¿å…ä¸­é—´å•†èµšå·®ä»· ğŸ˜„.

![nginx-3.jpg](http://www.almx.top/image/blog/nginx-3.jpg)

### åå‘ä»£ç†

å…³äºåå‘ä»£ç†çš„ä¾‹å­, é‚£å°±æ¯”è¾ƒå¤šå•¦. æ¯”å¦‚, å­¤ç‹¬çš„ä½ èººåœ¨åºŠä¸Šå¤œä¸èƒ½å¯. äºæ˜¯ä¹, æ‹¿å‡ºæ‰‹æœº, ç‚¹äº®äº†å±å¹•, æ‹¨é€š `10086`, ä¸­å›½ç§»åŠ¨å°±ä¼šéšæœºåˆ†é…ä¸€ä¸ªå½“å‰å¤„äºç©ºé—²çš„å®¢æœMM, ä½ å¯ä»¥å’Œå®¢æœMMèŠèŠå¤©, é—®é—®å¥¹å®¶ä½å“ªé‡Œ, æœ‰æ²¡æœ‰ç”·æœ‹å‹, å¥¹çš„å¾®ä¿¡å·, å¥¹çš„æ‰‹æœºå·, æ˜Ÿåº§, å…«å­—.......

åœ¨è¿™ä¸ªä¾‹å­ä¸­, ä¸­å›½ç§»åŠ¨å°±å……å½“äº†åå‘ä»£ç†çš„è§’è‰². ä½ åªéœ€è¦æ‹¨æ‰“ `10086`. è‡³äºä¼šä¸ä¼šåˆ†é…åˆ° MM ä¼šåˆ†é…åˆ°å“ªä¸ª MM åœ¨æ¥é€šä¹‹å‰ä½ éƒ½æ˜¯ä¸çŸ¥é“çš„. åå‘ä»£ç†åœ¨äº’è”ç½‘ä¸­çš„ä½¿ç”¨ä¸»è¦æ˜¯å®ç°è´Ÿè½½å‡è¡¡. å½“ä½ è®¿é—®æŸä¸ªç½‘ç«™çš„æ—¶å€™, åå‘ä»£ç†æœåŠ¡å™¨ä¼šä»å½“å‰ç½‘ç«™çš„æ‰€æœ‰æœåŠ¡å™¨ä¸­é€‰æ‹©ä¸€ä¸ªç©ºé—²çš„æœåŠ¡å™¨ä¸ºä½ å“åº”. ç”¨äºå‡è¡¡æ¯å°æœåŠ¡å™¨çš„è´Ÿè½½ç‡.

## ä¿®æ”¹ hosts å®ŒæˆåŸŸåç»‘å®š

mac ç”¨æˆ·ç›´æ¥æ‰§è¡Œ `vim /private/etc/hosts` åœ¨ `hosts` æ–‡ä»¶æœ€åæ·»åŠ ä¸€è¡Œ:

```nginx
127.0.0.1 a.com
```

è¿™ä¸€å¥æ˜¯ä»€ä¹ˆæ„æ€å‘¢? å°±æ˜¯å‘Šè¯‰æˆ‘ä»¬çš„ç”µè„‘è®¿é—® `a.com` çš„æ—¶å€™, æ— éœ€è¯·æ±‚ `DNS`, ç›´æ¥æŒ‡å‘æˆ‘ä»¬æœ¬æœº.

ps: `win` ç¯å¢ƒä¸‹, `hosts` æ–‡ä»¶åœ¨ `C:\Windows\System32\drivers\etc` æ–‡ä»¶å¤¹ä¸‹. å¦‚æœæ²¡æœ‰æƒé™ä¿®æ”¹, æŠŠ `hosts` æ–‡ä»¶å…ˆæ‹·è´åˆ°åˆ«çš„ä½ç½®, é€šè¿‡ç¼–è¾‘å™¨æ‰“å¼€å¹¶æ·»åŠ æœ€åä¸€è¡Œå†…å®¹ä»¥åå†å‰ªåˆ‡åˆ°åŸæ¥çš„ä½ç½®æ›¿æ¢å³å¯.

éªŒè¯: æ‰“å¼€å‘½ä»¤è¡Œçª—å£æ‰§è¡Œ `ping a.com`, å¦‚æœè®¿é—®çš„ `ip ä¸º 127.0.0.1` è¯´æ˜æˆ‘ä»¬çš„åŸŸåç»‘å®šå°±å®Œæˆå•¦ ^_^

![nginx-4.gif](http://www.almx.top/image/blog/nginx-4.gif)

## å®‰è£… nginx

>è¦åš `NGINX` åå‘ä»£ç†, è‚¯å®šè¦å®‰è£… [nginx](http://nginx.org/), æœ¬æ–‡å®‰è£…æ­¥éª¤ç¤ºä¾‹ç¯å¢ƒä¸º mac, win çš„å°ä¼™ä¼´, å¯ä»¥ç™¾åº¦ä¸€ä¸‹å—·, è¿™ä¸ªä¸œè¥¿å¤§åŒå°å¼‚.

- å®‰è£… `brew` å‘½ä»¤, æ‰§è¡Œ `ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"`
- å®‰è£… `nginx`, æ‰§è¡Œ `brew install nginx`
- å¯åŠ¨ `nginx nginx`, å¦‚æœæŠ¥æ²¡æœ‰æƒé™, æ‰§è¡Œ `sudo nginx`

`nginx` å¯åŠ¨å, æµè§ˆå™¨æ‰“å¼€ [localhost:8080](localhost:8080), å³å¯éªŒè¯. å‡ºç°ä»¥ä¸‹ç•Œé¢è¯´æ˜å®‰è£…æˆåŠŸ.

![nginx-5.jpg](http://www.almx.top/image/blog/nginx-5.jpg)

## nginx é…ç½®åˆæ¢

é…ç½®å®Œ `hosts` åŸŸåå·²ç»èƒ½å¤ŸæˆåŠŸç»‘å®š. ç°åœ¨å¦‚æœæˆ‘ä»¬è®¿é—® `a.com` å®é™…ä¸Šæ˜¯ä¼šè®¿é—®åˆ°æˆ‘ä»¬çš„è‡ªå·±çš„ç”µè„‘è¾£. é‚£è¿˜ä¸æŠ“ç´§è¯•ä¸€ä¸‹?

æµè§ˆå™¨è®¿é—® [a.com](a.com)

![nginx-6.jpg](http://www.almx.top/image/blog/nginx-6.jpg)

è¿™æ˜¯ä»€ä¹ˆé¬¼????

![nginx-7.jpg](http://www.almx.top/image/blog/nginx-7.jpg)

ä¸ºä»€ä¹ˆä¼š æ— æ³•è®¿é—®æ­¤ç½‘ç«™ å‘¢? æˆ‘ä»¬ä¸‹è½½å®‰è£…å®Œ `nginx` è¿˜æ²¡æœ‰åšä»»ä½•é…ç½®. æ¥ä¸‹æ¥, æˆ‘ä»¬ç¨å¾®é…ç½®ä¸€ä¸‹å°± OK:

- å‘½ä»¤è¡Œåˆ‡æ¢åˆ° `nginx` é…ç½®ç›®å½•ä¸‹ `cd /usr/local/etc/nginx/servers`
- åˆ›å»ºå¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶ `vim test.conf`, åœ¨é…ç½®æ–‡ä»¶ä¸­ç²˜è´´ä»¥ä¸‹å†…å®¹

```shell
server {
    # ç›‘å¬80ç«¯å£å·
    listen 80;

    # ç›‘å¬è®¿é—®çš„åŸŸå
    server_name a.com;

    # æ ¹æ®è®¿é—®è·¯å¾„é…ç½®
    location / {
        # æŠŠè¯·æ±‚è½¬å‘åˆ° https://www.baidu.com
        proxy_pass https://www.baidu.com;
    }
}
```

- ä¿å­˜æ–‡ä»¶, å¹¶æ‰§è¡Œ `nginx -s reload` é‡å¯ `nginx`.
- å›åˆ°æµè§ˆå™¨, æ‰“å¼€ [a.com](a.com) çš„é¡µç­¾, å¼ºåˆ¶åˆ·æ–°.

![nginx-8.jpg](http://www.almx.top/image/blog/nginx-8.jpg)

æ­å–œä½ å·²ç»å®Œæˆäº†ç¬¬ä¸€ä¸ª `nginx` é…ç½®.

![nginx-9.gif](http://www.almx.top/image/blog/nginx-9.gif)

## åˆ›å»ºè·¨åŸŸç¯å¢ƒ

>é€šè¿‡ä¸€ç³»åˆ—çš„æŠ˜è…¾, æˆ‘ä»¬å·²ç»å¯ä»¥é€šè¿‡ `nginx` å°†`a.com` è½¬å‘åˆ°ç™¾åº¦. å®Œæˆäº†ç¬¬ä¸€æ­¥, æ¥ä¸‹æ¥æˆ‘ä»¬åˆ›å»ºè·¨åŸŸçš„ `Case` å¹¶ä¸€æ­¥ä¸€æ­¥é€šè¿‡ `nginx` é…ç½®å®ç°è·¨åŸŸ.

é¦–å…ˆ, é¡¹ç›®å‰åç«¯æ·»åŠ  `nginx` ç›®å½•, ç”¨æˆ·å­˜æ”¾å‰åç«¯ä»£ç . ä»£ç ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º.

![nginx-10.jpg](http://www.almx.top/image/blog/nginx-10.jpg)

å…¶æ¬¡ç¼–å†™å‰åç«¯ä»£ç :

å‰ç«¯ä»£ç `(./fe/nginx/index.html)`:

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>CORS å®ç°è·¨åŸŸ</title>
</head>
<body>
    <h3>CORS å®ç°è·¨åŸŸ</h3>

    <script>
        var xhr = new XMLHttpRequest()
        xhr.open('GET', 'http://localhost:8888/api/getFriend')
        xhr.setRequestHeader('token', 'quanquanbunengshuo')
        xhr.withCredentials = true;
        xhr.onreadystatechange = function() {
            if(xhr.readyState === 4 && xhr.status === 200) {
                console.log(xhr.responseText)
                console.log(xhr.getAllResponseHeaders())
            }
        }
        xhr.send()
    </script>
</body>
</html>
```

ç¼–å†™å®Œå‰ç«¯ä»£ç ä»¥å, å¯åŠ¨å‰ç«¯ `web` å®¹å™¨. `live-server ./fe/nginx`

![nginx-11.jpg](http://www.almx.top/image/blog/nginx-11.jpg)

å‘½ä»¤è¡Œä¸­å‡ºç°äº†é»„è‰²è­¦å‘Š, é€šçŸ¥æˆ‘ä»¬ `8080` ç«¯å£å·²ç»è¢«å ç”¨, è¿™åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢? å¤§å®¶è¯·æ€è€ƒä¸€å“ˆ.

![nginx-12.jpg](http://www.almx.top/image/blog/nginx-12.jpg)

æˆ‘ä»¬é‡æ–°æŒ‡å®šä¸€ä¸ªç«¯å£`live-server ./fe/nginx --port=9999` å“ˆå“ˆ, æ¢ä¸€ä¸ªæŒ‡ä»¤, ä¾æ—§æ˜¯é‚£ä¹ˆé¡ºç•…. ^_^

åç«¯ä»£ç :

```js
const http = require('http');

const PORT = 8888;

// åˆ›å»ºä¸€ä¸ª http æœåŠ¡
const server = http.createServer((request, response) => {
  console.log(request.headers)
  response.end("{name: 'quanquan', friend: 'guiling'}");
});

// å¯åŠ¨æœåŠ¡, ç›‘å¬ç«¯å£
server.listen(PORT, () => {
  console.log('æœåŠ¡å¯åŠ¨æˆåŠŸ, æ­£åœ¨ç›‘å¬: ', PORT);
});
```

å¯åŠ¨åç«¯æœåŠ¡ `node ./be/nginx/index.js`

## å®Œå–„ nginx é…ç½®

>å‰åç«¯ä»£ç å·²ç»å‡†å¤‡å®Œæˆ, è¿™ä¸€æ­¥æˆ‘ä»¬å°±æ¥ç‚¹å¹²è´§. å®Œæˆæœ€åçš„é…ç½®.

- é¦–å…ˆ, ä¿®æ”¹ `nginx` é…ç½®, æŠŠç™¾åº¦åœ°å€æ›¿æ¢æˆæœ¬åœ°çš„å‰ç«¯åœ°å€

```shell
server {
    # ç›‘å¬80ç«¯å£å·
    listen 80;

    # ç›‘å¬è®¿é—®çš„åŸŸå
    server_name a.com;

    # æ ¹æ®è®¿é—®è·¯å¾„é…ç½®
    location / {
        # æŠŠè¯·æ±‚è½¬å‘åˆ° http://127.0.0.1:9999
        proxy_pass http://127.0.0.1:9999;
    }
}
```

- ä¿®æ”¹å®Œæˆ Â· é…ç½®æ–‡ä»¶ä»¥å, åˆ‡è®°æ‰§è¡Œ `nginx -s -reload` é‡å¯ `nginx`.
- è®¿é—®[a.com](a.com)

![nginx-13.jpg](http://www.almx.top/image/blog/nginx-13.jpg)

ç†Ÿæ‚‰çš„æŠ¥é”™åˆå‡ºç°äº†...

- ä¿®æ”¹å‰ç«¯é¡¹ç›®ä¸­çš„æ¥å£åœ°å€

```js
// æ¥å£åœ°å€ä¿®æ”¹ä¸ºå½“å‰åŸŸåä¸‹ /api è·¯åŠ²ä¸‹çš„ getFriend
xhr.open('GET', '/api/getFriend')
```

- ä¿®æ”¹ `nginx` é…ç½®æ–‡ä»¶

```nginx
server {
    # ç›‘å¬80ç«¯å£å·
    listen 80;

    # ç›‘å¬è®¿é—®çš„åŸŸå
    server_name a.com;

    # æ ¹æ®è®¿é—®è·¯å¾„é…ç½®
    location / {
        # æŠŠè¯·æ±‚è½¬å‘åˆ° http://127.0.0.1:9999
        proxy_pass http://127.0.0.1:9999;
    }

    # ç›‘å¬æ ¹ç›®å½•ä¸‹çš„ /api è·¯å¾„
    location /api/ {
        # æŠŠè¯·æ±‚è½¬å‘åˆ° http://127.0.0.1:8888
        proxy_pass http://127.0.0.1:8888;
    }
}
```

æ–°åŠ çš„å¯¹äº `api` è·¯å¾„çš„ç›‘å¬çš„æ„æ€å°±æ˜¯æŠŠå…³äºåç«¯ `api` çš„è¯·æ±‚è½¬å‘åˆ°åç«¯é¡¹ç›®ä¸Š(å“ˆå“ˆ, å½“ç„¶è¿™å°±æ˜¯ä¸ºå•¥å¥½å¤šåç«¯æ¥å£éƒ½æ˜¯è¦æœ‰ Â· å¼€å¤´çš„å•¦). é‡å¯ `nginx` ä»¥å, å†æ¬¡åˆ·æ–°æµè§ˆå™¨, åç«¯è¿”å›çš„ç»“æœå·²ç»æˆåŠŸçš„æ‰“å°åˆ°äº†æ§åˆ¶å°, æœ¬æ¬¡è·¨åŸŸè®¿é—®ä»»åŠ¡å®Œæˆ.

![nginx-14.jpg](http://www.almx.top/image/blog/nginx-14.jpg)

ç»†å¿ƒçš„å°ä¼™ä¼´è‚¯å®šå‘ç°äº†, æ§åˆ¶å°è¿˜æœ‰ä¸€ä¸ªæŠ¥é”™. è¿™ä¸ªæ˜¯å› ä¸ºæˆ‘ä»¬çš„é¡¹ç›®ä¸­ç”¨åˆ°äº† `live-server` è¿™ä¸ªå·¥å…·éœ€è¦ `websocket` å¯¼è‡´çš„. æˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ ä»¥ä¸‹é…ç½®è§£å†³.

```nginx
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";
```

![nginx-15.jpg](http://www.almx.top/image/blog/nginx-15.jpg)

æŠ¥é”™æ¶ˆå¤± ğŸ˜„, æ­¤æ—¶å®Œæ•´çš„ `nginx` é…ç½®æ–‡ä»¶ä¸º

```nginx
server {
    # ç›‘å¬80ç«¯å£å·
    listen 80;

    # ç›‘å¬è®¿é—®çš„åŸŸå
    server_name a.com;

    # æ ¹æ®è®¿é—®è·¯å¾„é…ç½®
    location / {
        # æŠŠè¯·æ±‚è½¬å‘åˆ° http://127.0.0.1:9999
        proxy_pass http://127.0.0.1:9999;

        # å…¼å®¹websocket
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ç›‘å¬æ ¹ç›®å½•ä¸‹çš„ /api è·¯å¾„
    location /api/ {
        # æŠŠè¯·æ±‚è½¬å‘åˆ° http://127.0.0.1:8888
        proxy_pass http://localhost:8888;
    }
}
```

å‰åç«¯ä»£ç åœ°å€ä¸º: [github](https://github.com/luoquanquan/cross-domain/commit/f38f56689fdac1526244ecadaa979a52c9c4a7ea)

## æ€»ç»“

è‡³æ­¤, æˆ‘ä»¬å·²ç»é€šè¿‡ nginx åå‘ä»£ç†çš„æ–¹å¼å®ç°äº†è·¨åŸŸè®¿é—® `api`, å¯¹äºè·¨åŸŸçš„è§£é‡Šä¸º: è·¨åŸŸæºäºåŒæºç­–ç•¥, æ˜¯æµè§ˆå™¨ä¿è¯ç”¨æˆ·å®‰å…¨çš„è¡Œä¸º. æˆ‘ä»¬ä½¿ç”¨çš„ `nginx` åå‘ä»£ç†å®é™…ä¸Šæ˜¯å¯¹æµè§ˆå™¨çš„ä¸€ç§ "å“„éª—", è®©å®ƒè®¤ä¸ºè‡ªå·±è®¿é—®åˆ°çš„æ˜¯åŒåŸŸçš„ api. å®é™…ä¸Šæ˜¯åœ¨æœåŠ¡ç«¯åšäº†ä¸ªè°ƒåŒ…, è¿™ä¸ªé“ç†å°±å¦‚åŒä½ æ‹¨æ‰“ `10086` ä½ å°±è®¤å®šäº†ç»™ä½ åˆ†é…åˆ°çš„ä¸€å®šæ˜¯`ä¸­å›½ç§»åŠ¨çš„å®¢æœMM`(å®¢æœGGä¹Ÿæ˜¯æœ‰å¯èƒ½å‡ºç°çš„ ğŸ˜„)è€Œ`ä¸­å›½ç§»åŠ¨çš„å®¢æœMM`å°±æ˜¯ä¸€ä¸ªå¾ˆå®‰å…¨çš„èŠå¤©å¯¹è±¡, æ²¡æœ‰å¿…è¦å†è¿›è¡Œé™åˆ¶...